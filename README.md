# iOptron Mount MATLAB Driver

This is a MATLAB driver for the iOptron iEQ30-Pro mount - a motorized German equatorial mount. With it, you can control mount movement and take orientation readings.

A lot of it should be transferable to other iOptron mounts (though this hasn't been tested).

## Installation

Follow these steps:

1. Download the iOptron Commander and ASCOM Driver from [iOptron's iEQ30-Pro website](http://www.ioptron.com/product-p/3000e.htm). This allows your computer to detect the mount and associate it with a COM port.
2. Download the [Sky Survey script](https://github.com/kamirov/matlab-sky-survey) if you want to run sky surveys with the mount.
3. Instantiate with `m = iopt_mount(<com_port_string>)`.

## Driver Usage
`iopt_mount` is the MATLAB class that interfaces with the mount.

The rest of this section describes the methods related to various uses.

### General Communication

#### `send(command, process, async)`

- General “send a command” method.
- `command` – command string(s).
- This can be a single command or multiple commands strung together.
  - e.g. “:AG#”
  - e.g. “:GEC#:GLT#:Gt#:Gg#”
- `process` – Boolean. Set to true if you expect a response.
- `async` – Boolean. If true, then command is asynchronous. Otherwise command is synchronous (pauses system until its response is processed or it times out).

#### `send_simple(command)`

- Sends an asynchronous, no-response command.
- Wrapper for `send(command, false, true)`.

### Moving

#### `set_speed(speed)`
- Sets mount slew rate.
- `speed` – integer. Values are 1-9, where 1 stands for 1x sidereal tracking rate, 2 stands for 2x, 3 stands for 8x, 4 stands for 16x, 5
stands for 64x, 6 stands for 128x, 7 stands for 256x, 8 stands for 512x, 9 stands for maximum speed.

#### `move(pos, start_readings, is_ra_dec, in_survey)`
- Rotates the mount to a given position.
- `pos` – 1×2 vector representing [Ra, Dec] or [Az, El]. Values should be in degrees.
- `start_readings` – Boolean. If true, mount will start taking readings and saving them to the object as it moves.
- `is_ra_dec` – Boolean. If true, then `pos` is interpreted as [Ra, Dec]. If false, will be interpreted as [Az, El]. The mount is equatorial, so horizontal coordinates will be converted.
- `in_survey` – Boolean. If true, then this move command was called from within a sky survey.
   - This should be removed. We should just set a private object property to determine if we’re in a sky survey or manually moving.

#### `slew_test()`

- Debug function. Sets a speed, moves west, starts taking readings.

#### `stop()`

- Stops taking readings and moving.

### Reading

#### `clear_readings()`
- Clears the `readings` property on the object.

#### `save_readings(clear_after)`
- Saves readings to a file with the name `MountReadings-%DATETIME%readings.mat`
- `clear_after` – Boolean. If true, will clear on-board readings after saving.

#### `take_readings()`

- Takes position, time, and GPS readings. Instantaneous values can be seen in the following object properties:
   - `pos`
   - `gps`
   - `date`
   - `tme`
   - `utc_offset`
   - `timestamps`
- Packages, timestamps, and stores these in the `readings` property on the mount

#### `start_readings()`
- Start taking regular readings
- Default period is 0.5s. Periods lower than this are unstable (mount becomes unresponsive after a while)


### Sky Survey

#### `make_survey(el_min, t_test, fov, lat, lon, store_survey, parent_dir)`
- Generates a sky survey, stores it on the object (doesn’t start the survey), and shows plots relevant to the survey
- `el_min` – Minimum elevation [deg]
- `t_test` – Test ime [min]
- `fov` – Field of view (half-cone) [deg]
- `lat` – Latitude [deg]
- `lon` – Longitude [deg]
- `store_survey` – Booelan. If true, will generate a log file and store trajectory on the object. Set this to false if you want to see the sky survey, but not actually use it.

#### `remake_survey(dir)`

- Remakes a sky survey from a directory generated by make_survey(). This is useful if the mount has been reset, but you want to continue a previous sky survey.
- `dir` – Absolute path to the directory
   - e.g. `C:\mount_surveys\SkySurvey_20160704T110628_to_20160704T120528\`

#### `run_survey(st, control, test_mode)`

- Runs survey currently on the object. Continuously takes mount and ST telemetry readings during the survey.
- `st` – star tracker sructure, serial port, or a COM port string.
- `control` – ST control structure. If empty, user locally saved control structure. If no locally saved one, uses on-board value and locally saves one.
- `test_mode` – Boolean. If true, spoofs ST calls (good for debugging)

## MATLAB Driver Details
This section describes the backend functionality of the mount. This is useful to anyone editing the `iopt_mount` class to add functionality.

### Initialization
Initialization happens automatically in the constructor. No need to manually initialize. Initialization consists of the following:

Confirm we have all the class dependencies on the MATLAB path.
1. Initialize communication with the mount – open the port, clear the buffer (this might not be needed).
2. Initialize the timeout and process timers (see the sections below for more about these).
3. Initialze the firmware. This sends 3 initialization commands that the mount firmware requires.
4. Initialize the state. This gets the initial position, time, and orientation as found by the mount and stores it on the object.

Relevant scripts:

- `confirm_dependencies.m`
- `init_comm.m`
- `init_timers.m`
- `init_firmware.m`
- `init_state.m`

### General Communication
When we send a message to the mount, we will get one of 3 responses:

- Response with the terminator #
  - e.g. “123#”
- Response with no terminator
  - e.g. “1”
- No response
  - e.g.

To complicate this, we usually need to issue commands asynchronously (i.e. we don’t wait to hear for a response before we send a command) and need to react to responses asynchronously. To add some more fun, some sets of commands need to be processed sequentially (e.g. setup commands must finish processing before we issue move commands).

We handle this with a command queue. When we issue a command, it gets added to the queue. When we receive a response, the response is processed and the first command we sent gets removed from the queue (FIFO-style). Commands that don’t expect a response don’t get added to the queue.

So, when we send a command, we must specify if (a) it is synchronous, and (b) if it gets added to the command queue.

Relevant scripts:
- `send.m`
- `send_simple.m`
- `async_callback.m`
- `process_packet.m`

#### Timing Out
All commands (sync and async) have a max allowable runtime, defined in the `command_timeout` property. The timeout timer asynchronously checks the command queue every `command_timeout/2` seconds for any commands that have timed out. Any that have will be removed from the queue.

Relevant scripts:
- `init_timers.m`
- `check_timeouts.m`

#### Synchronicity
After sending a synchronous commands, the object pauses until the entire command queue is cleared. This guarantees that no other commands will be processed until the synchronous command’s response has been processed or it has timed out.

Relevant scripts:
- `sync_hold.m`

### Moving
Moving consists of sending 4 commands to the mount:
1. Set RA (sync)
2. Set declination (sync)
3. Slew (sync)
4. Update status (async)

The update command updates the MATLAB object’s `status` structure with the status of various modules.

Relevant scripts:

- `move.m`
- `wait_for_slew.m`
- `update_status.m`

### Reading
Details to come.

### Sky Survey
Details of the sky survey logic can be found at the [Sky Survey page](https://github.com/kamirov/matlab-sky-survey).